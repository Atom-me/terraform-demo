# Consul é«˜å¯ç”¨é›†ç¾¤ Makefile
.PHONY: help init plan apply destroy validate fmt clean status ssh-server ssh-client

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# ä» setup.config è¯»å–é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
ifneq (,$(wildcard setup.config))
    include setup.config
    export
endif

# é…ç½®å˜é‡ - ä¼˜å…ˆçº§ï¼šå‘½ä»¤è¡Œå‚æ•° > setup.config > é»˜è®¤å€¼
PREFIX ?= my-consul
REGION ?= us-east-1
AWS_PROFILE ?= default
KEY_NAME ?= my-key-pair
SSH_PRIVATE_KEY ?= ~/.ssh/id_rsa
SSH_PUBLIC_KEY ?= ~/.ssh/id_rsa.pub

# å¦‚æœ setup.config ä¸­æœ‰ AWS_REGIONï¼Œè¦†ç›– REGION
ifdef AWS_REGION
    REGION := $(AWS_REGION)
endif

# Terraform å˜é‡
TF_VARS := -var="prefix=$(PREFIX)" \
           -var="region=$(REGION)" \
           -var="aws_profile=$(AWS_PROFILE)" \
           -var="key_name=$(KEY_NAME)" \
           -var="ssh_private_key=$(SSH_PRIVATE_KEY)" \
           -var="ssh_public_key=$(SSH_PUBLIC_KEY)"

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Consul é«˜å¯ç”¨é›†ç¾¤ç®¡ç†å‘½ä»¤ï¼š"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹ï¼š"
	@echo "  make plan                                    # ä½¿ç”¨é»˜è®¤å‚æ•°æˆ– setup.config"
	@echo "  make apply PREFIX=test REGION=us-west-2      # æŒ‡å®šå‰ç¼€å’ŒåŒºåŸŸ"
	@echo "  make apply AWS_PROFILE=production            # æŒ‡å®š AWS profile"
	@echo "  make destroy PREFIX=test AWS_PROFILE=dev     # é”€æ¯æŒ‡å®šç¯å¢ƒ"
	@echo ""
	@echo "é…ç½®æ–‡ä»¶ï¼š"
	@echo "  cp setup.config.example setup.config        # åˆ›å»ºé…ç½®æ–‡ä»¶"
	@echo "  ç¼–è¾‘ setup.config è®¾ç½®é»˜è®¤å‚æ•°                # é¿å…æ¯æ¬¡è¾“å…¥å‚æ•°"
	@echo ""
	@echo "å½“å‰é…ç½®ï¼š"
	@echo "  PREFIX=$(PREFIX)"
	@echo "  REGION=$(REGION)" 
	@echo "  AWS_PROFILE=$(AWS_PROFILE)"
	@echo "  KEY_NAME=$(KEY_NAME)"
	@echo "  SSH_PRIVATE_KEY=$(SSH_PRIVATE_KEY)"
	@echo "  SSH_PUBLIC_KEY=$(SSH_PUBLIC_KEY)"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@echo ""
	@echo "  \033[33måŸºç¡€å‘½ä»¤:\033[0m"
	@grep -E '^(setup|init|validate|fmt|plan|apply|destroy):.*?## .*$$' Makefile | awk 'BEGIN {FS = ":.*?## "}; {printf "    \033[36m%-13s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "  \033[33mé›†ç¾¤ç®¡ç†:\033[0m"
	@grep -E '^(status|consul-status|ui|ssh-server|ssh-client|test-ssh|logs-server|logs-client):.*?## .*$$' Makefile | awk 'BEGIN {FS = ":.*?## "}; {printf "    \033[36m%-13s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "  \033[33må¼€å‘å·¥å…·:\033[0m"
	@grep -E '^(dev-init|dev-deploy|dev-test|clean|clean-secrets|clean-all):.*?## .*$$' Makefile | awk 'BEGIN {FS = ":.*?## "}; {printf "    \033[36m%-13s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "  \033[33må…¶ä»–:\033[0m"
	@grep -E '^(help|prod-deploy):.*?## .*$$' Makefile | awk 'BEGIN {FS = ":.*?## "}; {printf "    \033[36m%-13s\033[0m %s\n", $$1, $$2}'

setup: ## åˆ›å»ºé…ç½®æ–‡ä»¶
	@if [ ! -f setup.config ]; then \
		cp setup.config.example setup.config; \
		echo "âœ… å·²åˆ›å»º setup.configï¼Œè¯·ç¼–è¾‘é…ç½®åå†è¿è¡Œéƒ¨ç½²å‘½ä»¤"; \
		echo "ğŸ’¡ æç¤ºï¼šç¼–è¾‘ setup.config æ–‡ä»¶è®¾ç½®æ‚¨çš„ AWS_PROFILE å’Œå…¶ä»–å‚æ•°"; \
	else \
		echo "âš ï¸  setup.config å·²å­˜åœ¨"; \
	fi

init: ## åˆå§‹åŒ– Terraform
	terraform init

validate: ## éªŒè¯ Terraform é…ç½®
	terraform validate

fmt: ## æ ¼å¼åŒ– Terraform ä»£ç 
	terraform fmt -recursive

plan: ## ç”Ÿæˆ Terraform æ‰§è¡Œè®¡åˆ’
	@echo "æ­£åœ¨ç”Ÿæˆæ‰§è¡Œè®¡åˆ’..."
	@echo "å‚æ•°: PREFIX=$(PREFIX) REGION=$(REGION) AWS_PROFILE=$(AWS_PROFILE)"
	terraform plan $(TF_VARS)

apply: ## éƒ¨ç½² Consul é›†ç¾¤
	@echo "æ­£åœ¨éƒ¨ç½² Consul é›†ç¾¤..."
	@echo "å‚æ•°: PREFIX=$(PREFIX) REGION=$(REGION) AWS_PROFILE=$(AWS_PROFILE)"
	terraform apply $(TF_VARS) -auto-approve

destroy: ## é”€æ¯ Consul é›†ç¾¤
	@echo "æ­£åœ¨é”€æ¯ Consul é›†ç¾¤..."
	@echo "å‚æ•°: PREFIX=$(PREFIX) REGION=$(REGION) AWS_PROFILE=$(AWS_PROFILE)"
	terraform destroy $(TF_VARS) -auto-approve
	@echo ""
	@echo "æ¸…ç† Secrets Manager èµ„æº..."
	@aws --profile $(AWS_PROFILE) --region $(REGION) secretsmanager delete-secret --secret-id $(PREFIX)-consul-acl-token --force-delete-without-recovery 2>/dev/null || echo "Secret $(PREFIX)-consul-acl-token ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
	@aws --profile $(AWS_PROFILE) --region $(REGION) secretsmanager delete-secret --secret-id $(PREFIX)-consul-gossip-key --force-delete-without-recovery 2>/dev/null || echo "Secret $(PREFIX)-consul-gossip-key ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
	@aws --profile $(AWS_PROFILE) --region $(REGION) secretsmanager delete-secret --secret-id $(PREFIX)-consul-dns-request-token --force-delete-without-recovery 2>/dev/null || echo "Secret $(PREFIX)-consul-dns-request-token ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
	@echo "âœ… æ¸…ç†å®Œæˆ"

status: ## æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
	@echo "=== Terraform çŠ¶æ€ ==="
	terraform show
	@echo ""
	@echo "=== å®ä¾‹åˆ—è¡¨ ==="
	terraform output -json | jq -r '.server_ips.value[] as $$ip | "Server: \($$ip)"'
	terraform output -json | jq -r '.client_ips.value[] as $$ip | "Client: \($$ip)"'

ssh-server: ## SSH è¿æ¥åˆ°ç¬¬ä¸€ä¸ª Server èŠ‚ç‚¹
	@SERVER_IP=$$(terraform output -json | jq -r '.server_ips.value[0]'); \
	echo "è¿æ¥åˆ° Server: $$SERVER_IP"; \
	ssh -i $(SSH_PRIVATE_KEY) ubuntu@$$SERVER_IP

ssh-client: ## SSH è¿æ¥åˆ°ç¬¬ä¸€ä¸ª Client èŠ‚ç‚¹
	@CLIENT_IP=$$(terraform output -json | jq -r '.client_ips.value[0]'); \
	echo "è¿æ¥åˆ° Client: $$CLIENT_IP"; \
	ssh -i $(SSH_PRIVATE_KEY) ubuntu@$$CLIENT_IP

consul-status: ## æ£€æŸ¥ Consul é›†ç¾¤çŠ¶æ€
	@echo "=== Consul é›†ç¾¤æˆå‘˜ ==="
	@SERVER_IP=$$(terraform output -json | jq -r '.server_ips.value[0]'); \
	ssh -i $(SSH_PRIVATE_KEY) ubuntu@$$SERVER_IP "consul members"
	@echo ""
	@echo "=== Consul Leader ==="
	@SERVER_IP=$$(terraform output -json | jq -r '.server_ips.value[0]'); \
	ssh -i $(SSH_PRIVATE_KEY) ubuntu@$$SERVER_IP "consul operator raft list-peers"

ui: ## æ‰“å¼€ Consul UI
	@SERVER_IP=$$(terraform output -json | jq -r '.server_ips.value[0]'); \
	echo "Consul UI: http://$$SERVER_IP:8500"; \
	open "http://$$SERVER_IP:8500" || echo "è¯·æ‰‹åŠ¨æ‰“å¼€: http://$$SERVER_IP:8500"

clean: ## æ¸…ç† Terraform æ–‡ä»¶
	rm -rf .terraform
	rm -f .terraform.lock.hcl
	rm -f terraform.tfstate*
	rm -f *.tfplan

clean-secrets: ## å¼ºåˆ¶æ¸…ç† AWS Secrets Manager èµ„æº
	@echo "å¼ºåˆ¶æ¸…ç† Secrets Manager èµ„æº..."
	@echo "å‚æ•°: PREFIX=$(PREFIX) REGION=$(REGION) AWS_PROFILE=$(AWS_PROFILE)"
	@aws --profile $(AWS_PROFILE) --region $(REGION) secretsmanager delete-secret --secret-id $(PREFIX)-consul-acl-token --force-delete-without-recovery 2>/dev/null || echo "Secret $(PREFIX)-consul-acl-token ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
	@aws --profile $(AWS_PROFILE) --region $(REGION) secretsmanager delete-secret --secret-id $(PREFIX)-consul-gossip-key --force-delete-without-recovery 2>/dev/null || echo "Secret $(PREFIX)-consul-gossip-key ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
	@aws --profile $(AWS_PROFILE) --region $(REGION) secretsmanager delete-secret --secret-id $(PREFIX)-consul-dns-request-token --force-delete-without-recovery 2>/dev/null || echo "Secret $(PREFIX)-consul-dns-request-token ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
	@echo "âœ… Secrets æ¸…ç†å®Œæˆ"

clean-all: destroy clean clean-secrets ## å½»åº•æ¸…ç†æ‰€æœ‰èµ„æºå’Œæœ¬åœ°æ–‡ä»¶
	@echo "ğŸ§¹ å½»åº•æ¸…ç†å®Œæˆï¼"

logs-server: ## æŸ¥çœ‹ç¬¬ä¸€ä¸ª Server èŠ‚ç‚¹çš„ Consul æ—¥å¿—
	@SERVER_IP=$$(terraform output -json | jq -r '.server_ips.value[0]'); \
	ssh -i $(SSH_PRIVATE_KEY) ubuntu@$$SERVER_IP "sudo journalctl -u consul.service -f"

logs-client: ## æŸ¥çœ‹ç¬¬ä¸€ä¸ª Client èŠ‚ç‚¹çš„ Consul æ—¥å¿—
	@CLIENT_IP=$$(terraform output -json | jq -r '.client_ips.value[0]'); \
	ssh -i $(SSH_PRIVATE_KEY) ubuntu@$$CLIENT_IP "sudo journalctl -u consul.service -f"

test-ssh: ## æµ‹è¯•æ‰€æœ‰èŠ‚ç‚¹çš„ SSH å…å¯†ç™»å½•
	@echo "=== æµ‹è¯• Server èŠ‚ç‚¹å…å¯†ç™»å½• ==="
	@terraform output -json | jq -r '.server_ips.value[]' | while read ip; do \
		echo "æµ‹è¯• Server: $$ip"; \
		ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ubuntu@$$ip "echo 'âœ… Server $$ip å…å¯†ç™»å½•æˆåŠŸ'" || echo "âŒ Server $$ip å…å¯†ç™»å½•å¤±è´¥"; \
	done
	@echo ""
	@echo "=== æµ‹è¯• Client èŠ‚ç‚¹å…å¯†ç™»å½• ==="
	@terraform output -json | jq -r '.client_ips.value[]' | while read ip; do \
		echo "æµ‹è¯• Client: $$ip"; \
		ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no ubuntu@$$ip "echo 'âœ… Client $$ip å…å¯†ç™»å½•æˆåŠŸ'" || echo "âŒ Client $$ip å…å¯†ç™»å½•å¤±è´¥"; \
	done

# å¼€å‘ç›¸å…³å‘½ä»¤
dev-init: setup init fmt validate ## å¼€å‘ç¯å¢ƒåˆå§‹åŒ–ï¼ˆåŒ…å«é…ç½®æ–‡ä»¶åˆ›å»ºï¼‰

dev-deploy: dev-init plan apply ## å¼€å‘ç¯å¢ƒä¸€é”®éƒ¨ç½²

dev-test: consul-status test-ssh ui ## éƒ¨ç½²åæµ‹è¯•

# ç”Ÿäº§ç›¸å…³å‘½ä»¤
prod-deploy: ## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€è¦æ‰‹åŠ¨ç¡®è®¤ï¼‰
	@echo "âš ï¸  å³å°†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè¯·ç¡®è®¤ï¼š"
	@echo "å½“å‰å‚æ•°: PREFIX=$(PREFIX) REGION=$(REGION) AWS_PROFILE=$(AWS_PROFILE)"
	@read -p "è¾“å…¥ 'yes' ç»§ç»­: " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		make apply; \
	else \
		echo "å·²å–æ¶ˆéƒ¨ç½²"; \
	fi 